from pywinauto import Application
import time

# Função para tentar conectar a uma janela
def conectar_a_janela(app, nomes_janelas):
    for nome in nomes_janelas:
        try:
            janela = app.window(best_match=nome)
            janela.wait('visible', timeout=5)
            return janela
        except Exception as e:
            print(f"Janela '{nome}' não encontrada ou não está visível. Tentando próximo...")
    return None

# Inicia o aplicativo com o backend 'uia'
app = Application(backend='uia').start("D:/Dowloads/saida/Smartclients_Homologacao/Smartclients_Homologacao/SmartCliente_DMP_2310/smartclient.exe")

# Acessa a janela principal e clica no botão "Ok"
janela_principal = app.window(title_re=".*Parâmetros Iniciais.*")
botao_ok = janela_principal.child_window(title="Ok", control_type="Button")
botao_ok.click()

# Espera a nova janela abrir
time.sleep(8)

# Tenta conectar à nova janela usando os nomes possíveis
nomes_janelas = ["TOTVS Manufatura (TOTVS) 02.9.0099 - Ver: 20.3.2.7", ".*smartclient.*"]
nova_janela = conectar_a_janela(app, nomes_janelas)

if nova_janela:
    print(f"Conectado à janela: {nova_janela.window_text()}")

    # Ativa a janela para garantir que está em foco
    nova_janela.set_focus()
    
    # Interage com a nova janela
    from pywinauto.keyboard import send_keys

    # Escreve o nome de usuário
    send_keys("THARLYS.SANTOS")
    send_keys("{TAB}")
    send_keys("Th@rlys123")
    send_keys("{ENTER}")
    
    time.sleep(5)

    cont = 0

    while cont < 5:

        send_keys("{TAB}")

        cont += 1
    
    send_keys("{ENTER}")  

    time.sleep(3)

    botoes = nova_janela.descendants(control_type="Button")
    for botao in botoes:
        print(f"Botão encontrado: {botao.window_text()}")

    # Tenta clicar em um botão específico
    try:
        botao = nova_janela.child_window(control_type="Button", found_index=3)
        print(botao)
        botao.click()
    except Exception as e:
        print(f"Erro ao clicar no botão: {e}")

    # Itera sobre os controles filhos
    for child in nova_janela.children():
        print(child.window_text())
        if "Atualizações" in child.window_text():
            child.click()
            break

else:
    print("Nenhuma janela correspondente encontrada.")